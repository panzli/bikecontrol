name: Build Windows

on:
  workflow_dispatch: {}

env:
  FLUTTER_VERSION: 3.38.7

jobs:
  windows:
    name: Build Windows Executable
    runs-on: windows-latest
    env:
      FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Rename pubspec_overrides_ci.yaml to pubspec_overrides.yaml (if present)
        shell: pwsh
        run: |
          if (Test-Path pubspec_overrides_ci.yaml) {
            Rename-Item -Path pubspec_overrides_ci.yaml -NewName pubspec_overrides.yaml
          } else {
            Write-Output "No pubspec_overrides_ci.yaml found, skipping rename."
          }

      - name: Extract version from pubspec.yaml
        id: extract_version
        shell: pwsh
        run: |
          $versionLine = Select-String '^version: ' pubspec.yaml | Select-Object -First 1
          if ($versionLine) {
            $version = ($versionLine -split '\s+')[1].Trim()
            Write-Output "VERSION=$version" >> $env:GITHUB_ENV
            Write-Output "Detected version: $version"
          } else {
            Write-Output "VERSION=unknown" >> $env:GITHUB_ENV
          }

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        shell: pwsh
        run: |
          flutter pub get

      - name: Generate translation files
        shell: pwsh
        run: |
          flutter pub global activate intl_utils
          flutter pub global run intl_utils:generate

      - name: Build Windows (release)
        shell: pwsh
        run: |
          flutter build windows --release --obfuscate --split-debug-info=symbols-win

      - name: Copy common runtime DLLs into release folder (if present)
        shell: pwsh
        run: |
          $source = "$env:SystemRoot\System32"
          $destination = "build\windows\x64\runner\Release"
          $dlls = @("msvcp140.dll", "vcruntime140.dll", "vcruntime140_1.dll")
          foreach ($dll in $dlls) {
            $srcPath = Join-Path $source $dll
            $destPath = Join-Path $destination $dll
            if (Test-Path $srcPath) {
              Copy-Item -Path $srcPath -Destination $destPath -Force
              Write-Output "Copied $dll to $destination"
            } else {
              Write-Warning "$dll not found in $source"
            }
          }

      - name: Zip Windows release folder
        shell: pwsh
        run: |
          $releaseDir = "build\windows\x64\runner\Release"
          $zipPath = "build\windows\x64\runner\Release\bike_control.windows.zip"
          if (Test-Path $releaseDir) {
            if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
            Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipPath
            Write-Output "Created $zipPath"
          } else {
            Write-Error "Release directory not found: $releaseDir"
            exit 1
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: bike_control-windows-${{ env.VERSION || 'unknown' }}
          path: |
            build/windows/x64/runner/Release/bike_control.windows.zip
            build/windows/x64/runner/Release/**
